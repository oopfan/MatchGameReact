<!DOCTYPE html>
<html>
<head>
  <title>Match Game (React)</title>
  <link rel="stylesheet" href="./resources/css/reset.css" type="text/css">
  <link
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
    crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Work+Sans:400,700,900" rel="stylesheet">
  <link rel="stylesheet" href="./resources/css/style.css" type="text/css">
  <link rel="icon" href="./favicon.ico" type="image/x-icon">
  <script src="https://fb.me/react-0.14.7.js" type="text/javascript"></script>
  <script src="https://fb.me/react-dom-0.14.7.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.25/browser.min.js" type="text/javascript"></script>
</head>
<body>
  <div class="you-won">
    <span></span>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-md-3">
        <h1>Match Game</h1>
        <h2>Rules</h2>
        <p>
          Click on a card to reveal the number on the other side. Click on a second
          card to try and find a match to the first. If you succeed, the pair will
          be removed from play. If not, try again!
        </p>
        <h2>How To Win</h2>
        <p>
          You win when all pairs have been found.
        </p>
        <p id="restart-game-button">
        </p>
        <p id="new-game-button">
        </p>
      </div>
      <div id="game" class="col-md-9">
      </div>
    </div>
  </div>
  <script type="text/babel">
    var Button = React.createClass( {
      render: function() {
        return <button type="button" className="btn btn-default" onClick={this.clickButton}>{this.props.text}</button>;
      },
      clickButton: function() {
        gameRendered.action(this.props.action);
      }
    });
    var Game = React.createClass( {
      getInitialState: function() {
        return this.newGame();
      },
      render: function() {
        var cards = this.state.cards.map(function(card, index) {
          return <Card value={card.value} flipState={card.flipState} onCardClick={this.onCardClick.bind(this, index)} />;
        }, this);
        var game = <div className="row">{cards}</div>;
        return game;
      },
      onCardClick: function(cardIndex) {
        if (this.state.cards[cardIndex].flipState !== 'hidden') {
          return;
        }
        if (this.state.selected.length >= 2) {
          return;
        }

        var nextState = this.state;
        nextState.cards[cardIndex].flipState = 'selected';
        nextState.selected.push(cardIndex);
        this.setState(nextState);

        if (nextState.selected.length < 2) {
          return;
        }

        if (nextState.cards[nextState.selected[0]].value === nextState.cards[nextState.selected[1]].value) {
          nextState.cards[nextState.selected[0]].flipState = 'flipped';
          nextState.cards[nextState.selected[1]].flipState = 'flipped';
          nextState.selected = [];
          nextState.flipped += 2;
          if (nextState.flipped === 16) {
            console.log ('You won!');
          }
          this.setState(nextState);
          return;
        }

        var that = this;
        window.setTimeout(function() {
          nextState.cards[nextState.selected[0]].flipState = 'hidden';
          nextState.cards[nextState.selected[1]].flipState = 'hidden';
          nextState.selected = [];
          that.setState(nextState);
        }, 500);
      },
      action: function(actionValue) {
        if (actionValue === 'new') {
          this.setState(this.newGame());
        } else {
          this.setState(this.restartGame());
        }
      },
      newGame: function() {
        return {
          cards: this.generateCards(),
          selected: [],
          flipped: 0
        };
      },
      restartGame: function() {
        var cards = this.state.cards;
        cards.forEach(function(card) {
          card.flipState = 'hidden';
        });
        return {
          cards: cards,
          selected: [],
          flipped: 0
        };
      },
      generateCards: function() {
        var cardValues = this.generateCardValues();
        var cards = cardValues.map(function(cardValue) {
          return {
            value: cardValue,
            flipState: 'hidden'
          }
        });
        return cards;
      },
      generateCardValues: function() {
        var orderedCards = [];
        for (var i = 1; i <= 8; i++) {
          orderedCards.push(i);
          orderedCards.push(i);
        }
        var randomCards = [];
        while (orderedCards.length > 0) {
          var randomIndex = this.getRandomInt(0, orderedCards.length);
          randomCards.push(orderedCards[randomIndex]);
          orderedCards.splice(randomIndex, 1);
        }
        return randomCards;
      },
      getRandomInt: function(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
      }
    });
    var Card = React.createClass( {
      render: function() {
        var colors = [
          'hsl(25, 85%, 65%)',
          'hsl(55, 85%, 65%)',
          'hsl(90, 85%, 65%)',
          'hsl(160, 85%, 65%)',
          'hsl(220, 85%, 65%)',
          'hsl(265, 85%, 65%)',
          'hsl(310, 85%, 65%)',
          'hsl(360, 85%, 65%)',
        ];
        var style = {
          color: this.props.flipState === 'flipped' ? 'rgb(204, 204, 204)' : 'rgb(255, 255, 255)',
          backgroundColor: this.props.flipState === 'flipped' ? 'rgb(153, 153, 153)' : (this.props.flipState === 'selected' ? colors[this.props.value - 1] : 'rgb(32, 64, 86)')
        }
        return (
          <div onClick={this.props.onCardClick} className="col-xs-3 col-sm-3 col-md-3 col-lg-3 card" style={style}>
            <span>{this.props.flipState === 'hidden' ? '' : this.props.value}</span>
          </div>
        );
      }
    });
    var gameRendered = ReactDOM.render(
      <Game />,
      document.getElementById('game')
    );
    ReactDOM.render(
      <Button text="New Game" action="new" />,
      document.getElementById('new-game-button')
    );
    ReactDOM.render(
      <Button text="Restart Game" action="restart" />,
      document.getElementById('restart-game-button')
    );
  </script>
</body>
</html>
